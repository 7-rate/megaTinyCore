# Robust/production checklist
I hear of a lot of people deploying devices they designed at a scale of hundreds of devices - who have made clear that they have not performed due dilligence w/regards to design of the firmware and/or hardware and have barely tested anything.

I've tried not to stray too far from the main subject of megaTinyCore - without too much success because a lot of things that people need to do and aren't doing are not specific to megaTinyCore... This page is at times more flippant tham most of the reference; that's because unlike most of the subject matter covered in the core doumentation, this is less technical and more subjective - plus the situations are a times so absurd that it's hard to resist.

This is a work in progress, and is not exhaustive. It is however a starting point, and it covers a lot of things that are an absolute 100% must do for writing effective embedded code and deploying it successfully.

## Software design
These parts have multiple features for enhanced robustness. These can reduce or eliminate many causes of "hung" devices and parts ending up in inexplicable "bad states", prevent memory corruption, and guarantee that the code was not corrupted by some freak accident. These methods are essentially unused within the Arduino community. Before you make something into a product, you should consider whether these features fit your power budget and would be appriate for your project.

### Use BOD if you can spare the power
If not all the time, can you at least use sampled mode while the chip is awake? See the datasheet for your part to check the exact power consumption and compare to your power budget. If you can - use it! Without BOD, there is nothing to keep the chip from continuing to try to operate despite insufficient power supply voltage to function correctly. The processor may execute instructions incorrectly, memory may be corrupted, etc - and a chip in such an undervoltage state, if not disconnected by an undervoltage lockout circuit (UVLO) will tend to draw far more current that it would in sleep mode.

BOD will keep the chip in reset when you it knows the voltage is too low to keep the chip running.

### A boootloader is likely the right approach if you want end users to be uploading updates
There's a python library to upload via STK500 (the protocol we use) which would allow you to make an appropriate updater for your device

That is the only case in which it makes sense to use Optiboot on a device you are going to be selling (except a development board, but in that case, your users are hopefully able to manage "burn bootloader" if they want it... UPDI programming is about as easy as it gets).

### Use the WDT whenever you are not sleeping if preventing hangs is a priority
It can be inconvenient to have to keep feeding the dog - but this is a nearly bulletproof way to keep your code from getting hung! Watchdog timer use is very widespread in commercial products. The windowed feature gives you a way to fix the hole in this that existed on classic avrs - the potential for it to get hung in an area where the WDT was being repeatedly reset, but it had lost the ability

### Read the new reset reference
[The Reset Reference](./Ref_Reset.md) outlines both desired and intentional ways that the chip can be reset, and discusses *unintended* resets which generally result from software defects. megaTinyCore provides strong defense against "dirty resets" and will generally be able to reset cleanly, regardless of where the **missing word** come from. This is better than earlier versions of the core, which might blunder on after a "dirty rest", potentially ending up in a hung or malfunctioning state. The fact that virtually nobody in Arduino-land looks at the reset flags, clears them and takes corrective action when it looks during startup and doesn't find any likely accounts for the majority of the cases where parts get into a "bad state" and require a manual reset or power cycle. Since doing that is so rare in Arduino circles, we now do it within the core unless you override the relevant function.

That said, just because we ensure a clean reset does not mean you should allow an unexpected reset to go uninvestigated. A dirty reset with the stock defenses provided by the core will show up as GPIOR0 == RSTCTRL_SWRF_bm at the start of setup() when you know you didn't call a software reset yourself. You should seek to determine what is causing them (this is covered in the reset guide). Any system that is experiencing unexpected resets (WDT timeouts or dirty resets) should be viewed with suspicion until the cause is better understood, at which point they are no longer "unexpected" resets, and you can can make an informed decision about whether further action is needed. ("It resets sometimes when the air conditioner goes on because this second rate power supply doesn't deal with the transients very well" might very well be acceptable, particularly if you're not shipping it with that power supply. "It resets when the server it's trying to connect to is down and returns an error document that doesn't fit in the buffer" probably isn't (you're probably overflowing a buffer, and there likely exist perverse inputs that would cause worse behavior)... but "It resets every day or so, don't know why, but the code handles it, so no problem" is never acceptable!

### Never allow compile warnings to go univestigated, more often than not they indicate a defect
I think I've made it so you can't disable them in the Arduino IDE now with any of my cores. Robust code does not generate compile warnings; they are a HUGE red flag. At best they represent haphazard programming practices that you should tighten up and prevent from generating a warning (when you do not know how to prevent a warning, that is an indication that you do not understand some relevant aspect of the C/C++ language. And if you don't understand it, you are not qualified to declare that the warning is not a concern). Frequently they are latent (or active) bugs - what sets them apart is that unlike most bugs, these are carrying big neon signs telling you where they are.

### There's a CRC check feature on these parts
It can be set to automaticallty check the flash and compare it to a checksum stored at the end. We don't support this directly (or generate a hex with the CRC), but literally all you need to do to force it on once you calculate the CRC and put it at the end of the file you upload is to set the two high bits of SYSCGF0 to something other than 11. See the datasheet for details). If the firmware is misuploaded, or if it's corrupted by cosmic rays or god knows what else, the device will sit there bootlooping, rather than working well enough that the user believes it it's fine until it suddenly fails catastrophically at some crucial momemnt. Depending on the type of product and intended use case, this could be either a foolish obstacle that you don't want to use, or a necessary countermeasure that you absolutely must use (ie, the airbag controller in your car - if the part of the code that ran during normal operation was intact, but the portion that deployed the airbag was corrupted, you would want to notify the driver of the airbag problem, rather the)

### Disable digital input buffers of unused pins, or pull them up, or set them output. Don't let them float
This is more a matter of power consumption than robustness, but Microchip advises that minimum power consumption requires disabling the digital input buffer on all unused pins. Otherwise, the pins must not be allowed to float - pull them up, drive them high or low, but don't let them sit in an undefined state. The constant toggling of the input buffer can destroy any chance of low power consumption. This seems to be a bigger problem on modern AVRs than classic ones, though they had the same warning. Strictly speaking, any pin which you do not digitalRead() or trigger an interrupt from, ought to have the digital input buffer disabled - but only the ones that aren't pulled or driven into a defined state that is clearly a HIGH or LOW *need* this step taken. Pins that are only used as analog inputs should have the digital input buffer disabled - almost by definition, they will be sitting at the boundary between HIGH and LOW, allowing the digital input buffers to waste large amounts of power.

## Hardware design

### Consider all the ways the power supply voltage might vary
This includes not only ramping up and down, but also how it reacts to "brownout" situations where the voltage droops well below the nominal voltage and then recovers, and "glitches" where the power is briefly interrupted entirely - but not long enough for the device to power off fully (they are thus just another form of brownout. These latter two situations often troublesome and result in the same thing: Some parts reset cleanly, some parts continue functioning unimpeded, and some parts get into a confused state. Even if none of the parts come out in a bad state, if some reset and others don't, you have a problem: they are now making inaccurate assumptions about eachothers' states. You typically want the main microcontroller - if isn't in BOD - to allow adequate time for the power to rise such that all parts of the system are within spec. When devices have hardware reset pins, these can be used to great effect, allowing a way to reset other parts in the system. In the most extreme cases you may need to go as far as adding a P-cheannel fet to switch power to the other devicess. This is rarely necessary, though.

The ideal case is for all of the slave devices of all types to be within spec before any communiction is attempted. Reset sequencing is definitely a thing in electronics design.

Testing here is essential as the behavior of parts is often not clear in these events. While rigorous testing at different temperatures is desirable, it's also difficult. But there is nothing hard about quicly unplugging and repluging the power connector a few times, and there's nothing hard about connecting it to a bench powersupply, lowein the voltage until it stops working and than returning the voltage to nominal. And obviously it matters a great deal whether the power source is naurally prone to such things for whatever reason (particularly renewable power and energy harvesting)

#### If higher voltages than Vcc are involved, you have a second issue, likely far more important than the fist: How sure are you that there's no sneak path throgh which, under fault conditions, this higher voltage cant get onto Vcc, or a data line? If such a voltage could reach Vcc, you may need OVP. If spiks can reach data lines, they likly need additional protection. This is not specific to thes parts in any way; refer to [my general strategies for overvoltage protection](https://github.com/SpenceKonde/AVR-Guidance/blob/master/HardwareNotes/OVP.md)

### Make sure I2C always has appropriate pullups
Internal pullups are not sufficient. Never use UsePullups() except for diagnostics. See the description of UsePullups() in the [Wire Documentation](../libraries/Wire/README.md).

### Read the errarta FIRST
As in, before you're tripping over them and it's gating development, or worse, after you've shipped and your users are tripping over them and demanding a solution. On classic AVRs, there was often no non-trivial errata, often it would fit on a page. That is ah.... something that isn't quite true on the 0/1-series tiny AVR (or DA/DB, or mega 0-series); to give an idea of the extent of the contrast, consider that the table of errata and applicable silicon revs is longer than the entire errata on all but one classic AVR that I'm aware of, and only because it looks like an actual engineer wrote one of the descriptions of the errata and workaround.

Always hope for fixes to Errata. Do not expect them and certainly don't depend on them. We have no idea when - or if - those fixes will be coming. Sometimes that future die revision never happens. The poor ATtny1634 and 828 still have that broken pin, the x7 has gotten a new modernized package but is still the same old die, and it still loses the crystal gain when you switch clock sources. And as we all know very well, few of the tinyAVR 0 and 1-series parts have received much in the way of fixes, in spite of several die revisions that fixed nothing and an errata document whose table of contents is longer than the entire errata for most classic AVRs. Once you know what the errata impacting the hardware you are using are, you can plan around them and ensure that they don't become unexpected showstoppers (they may be *expected* showstoppers which wouod lead you to use a different part) when you discover them later. likewise, you are fore-warned of the possibility that the errata will one day be fixed, so you should be sure to not paint yourself into a corner by relying on the bug (the erratum that comes to mind here is the fact that you can reset the RTC prescaler on most 0/1-series parts by writign to RTC.CTRLA. That means that you can get a deterministic delay out of the PIT... (but you can't write RTC.CTRLA without screwing up all pending delays...).

#### A problem with the errata
The errata lists are not updated continually. Different sizes of 2-series get updates to errata separately, as do DA and DB. So some errata for the DA (with frequently updated errata) warns against setting a certain ombination of registers, because it will do something terrible like crash the chip, leave a periperal in a bad state, physically burn out the chip, or open a portal to hell from whence will issue the vengeful souls of the damned - you should not assume that the same bug is not present on rhe DB (whose errata hasn't been updated in ages). They are continually findin new errata which effects all modern AVRs.

#### Another problem with the errata
There is no columm for "Fix status" or "fix priorty". It would be terribly handy to know if a bug fix was done internally and would be encorporated into the next die rev (whenever that came), and if not, how they prioritize the varios issues. It would matter a great deal to me if a fix for some errata would let me improve my product to know that it was top priority or was ready for inclusion in the next die rev (maybe I should write the code now, or have docs ready talking about it, etc) - or that it was not considered a serious issue, and I probably should wait to see how progress fixing others is going. Even better would be some sort of indication of whenabout that next die rev might occur, even if vague "Productoin is planning no later than 1 quarter after resolution of all priorty 1 and 2 errtata" would be fantastic. As would notes like "due to the ease of workaround and the widespread nature of the issue, we do not expect to change this behavior" for low priority bugs (in that case, though, a datasheet clarification or update is in order!)

#### The final problem with the errata
There are tons of errata that apply to most or allpost-2016 parts. As a designer, it would be incredibly useful to see that all on one giant table, listing EVERY erratum that effeced any modern AVR part, which revisions it's fixed in (if any), So if I knew my reqirements were "At least 32k flash, and a fix for the bug with ____" I could quickly rule out parts where the errata preclude the use of that part, and find the ones where it doesn't. If the errata in question are widespread, this could be the difference between my finding and using te unimpacted part, or having to use a competitors product. Microchip needs to acknowlede the elephant in the room and give their customers more transpenrency on the matter of errata.

### Don't use overclocked parts in products
The modern AVRs overclock quite well, and the tinyAVRs can be overclocked easily using the internal oscillator. That should not be an invitation to use them like this in hardware you ship out to users who aren't embedded systems experts. Unless your customers fully understand what they're getting themselves into (ie, you're selling dev boards to embedded hardware people, in which case the standards are lower anyway). I will have overclocked Azduino Nano DB boards for sale. But I will make very clear that that's an overclock, the bootloader runs from the internal oscillator at a lower speed, and it's only overclocked if it runs from the crystal (that's why I didn't do it on certain classic AVRs where I wanted to - they generally don't support changing the clock source at runtime, so if you had one overclocked and it was not working well at that speed - it would be difficult to revive, whereas the modern AVRs would generally require the sketch code to go out of it's way to overclock the chip, and **Unfinished thought**), or if there was anything that would prevent uploading in-spec 24 MHz sketches that run from the internal oscillator instead. In all other cases, it should be avoided if at all possible. If it's not possible to avoid, you need to take the testing to a higher level than usual, and keep the overclock as small as possible small. If you do have to overclock in a product, definitely use the extended temperature range parts, and try to take more care with the power supply as well - particularly for tinyAVR parts (this is not quite as important for Dx-series w/rt overclocking, since most of the chip - including the CPU core which appears to be what fails first - is running at a lower voltage), while the tinyAVR still has the dependence of the clock speed on operating voltage.


### Don't skimp on the decoupling caps.
1x 0.1uF per pair of power and ground should be assumed for any part where the datasheet doesn't give a more specific recommendation. 1uF on the MVIO pin of parts with that feature (other side to ground), and for Faraday's sake, be sure to include some "board level" decoupling. Some parts explicitly specify a minimum (the Dx-series requires 1uF, but that is a bare minimum to keep the power supply slew rate below the maximum). *The manufacturers make what should be a correct assumption that the power supply rail is reasonably stable, and that at least some degree of famllariry with best practice (or at least acceptable opnes*. With several feet of wire between a wallwart or USB port, and nothing but the 0.1uF decoupling capacitors on the ICs themselves, you are not going to have that. The inductance of the wire is enough to interfere with correct operation of the  in practice, you want at least 4.7 or 10uF on any board. If there are intermittent loads supplied from the same power rail, you probably want significantly more. It is common to put multiple values of capacitors in parallel (0.1uf and 0.01uF decoupling next to an IC is common in more demanding applications, though usually not necessary on AVRs). At the ohter exyttrssmhe same board designed to plugstraight into a USB pot

#### USB powered devices have an upper limit on capacitance
USB has a limit on how much capacitance may be "seen" by the host. For more than 10uF, you're supposed to use inrush current limiting. It would seem that the inrush current limit is often not enforced strictly, if at all,  by USB hosts, (most cheaper USB hubs, particularly ones with their own external power supply, often simply tie the +5v pins of all the ports to the same +5v rail coming in from their power supply, in flagrant disregard of the USB standard) - sometimes plugging in a device with excessive capacitance and lacking inrush current limiting to such a hub will cause it and everything plugged into it to reset and reenumerate, as the inrush current pulls the USB hub's 5v rail down enough to reset it. A well designed device would make use of one of the many inrush current limiting IC's made for this express purpose, but this is frequently sacrificed in the name of cost cutting. As this document is dedicated to designing robust devices, that is obviously not recommended.

#### Resist the urge to use the tiniest ceramic caps you can find
which will meet your desired nominal capacitance and voltage rating, particularly for higher capacitances. Ceramic capacitors have a strong dependence on applied voltage ("DC bias"). Just because that 0805 22uF capacitor is rated for 35v doesn't mean you have a 22uF capacitor at 30V.... The larger manufacturers provide tools on their websites that will show you a graph - and in some cases even let you search based on effective capacitance at a specified DC bias. For example, the TDK C2012X5R1V226M125AC is a 22uF cap rated for 35V and it's tiny - 0805! So when you've got it on your +30V power rail, how much capacitance does it actually give you? According to [the tool on their website](https://product.tdk.com/en/search/capacitor/ceramic/mlcc/characteristic)? 1.25uF! Barely 1/20th of the nominal capacitance!  The capacitance at a given DC bias is typically dependent on the nominal capacitance, the process technology of the manufacturer, *and the physical volume of the capacitor*. It also depends on the dielectric - but not in a consistent manner. Playing with a tool like that one can be a great learning experience and will help you get a feel for how much capacitance you can get from a given package size at key voltages. TDK's process technology is excellent w/regards to DC bias performance. You're unlikely to find any manufacturer who has significantly better caps, but plenty are selling capacitors that are significantly worse. Murata has a similar, excellent tool on their website with more information and but slightly worse presentation; both allow search and sort by effective capacitance. While Murata has always been synonymous with ceramic capacitors, TDK solidly beats them for C vs DC bias - TDK will sell you a 47 uF 1210 that retains 42.8 uF effective capacitance at 5V, while Murata's best 1210's will only give you 27 uF (as of Q1 2022). You'll notice that there is a very distinct "ceiling effect"; for example, TDK also makes 100uF nominal capacitance 1210 capacitors... which at 5v will retain... 43.3 uF effective capacitance at 5V. In some cases, nominal capacitance comes at the expense of effective capacitance - those 100uF caps, which retain around 65 uF at 3V and 43.3 at 5V, at 8V, the 47 uF capacitors still have almost 34 uF, while the 100uF ones have fallen to 28 uF.

#### But ceramic caps larger than 1210 may pose reliability issues
Opinion is divided about physically massive capacitors (larger than 1210, most commonly 2020) with some people considering them too prone to cracking from board flex and thermal stresses, while others consider those concerns overblown (scientific papers have been devoted to the study of this matter under various conditions), and most manufacturers who produce such capacitors offer versions that embed them in a frame that prevents board flex from cracking the capacitors as easily. What isn't up for debate is that they are a lot more expensive. Anything larger than 1210 is dramatically more expensive (as in several dollars/ea)  and if you need high capacitance at more than a few volts, it might be time to ask yourself if you could use some other type of capacitor.

#### Non-ceramic capacitors
Nobody wants to use other kinds of capacitors. Up to a point, ceramic caps are dirt cheap, have very low ESR, and are compact, have a very long (practically unlimited) operational lifetime. But they get sharply more expensive as you start demanding an effective capacitance of 10uF or higher much beyond 5 volts. The major alternatives are aluminum electrolytic capacitors, and tantalum capacitors, colloquially referred to as tants. An aluminum electrolytic to provide bulk capacitance in parallel with a ceramic capacitor is often a good choice, and beyond a few hundred uF, aluminum electrolytics are the only game in town. The capacitance is virtually independent of applied DC bias, and values of thousands of microfarads are not uncommon, and for larger values, the cost scaling is very favorable. Unlike ceramic capacitors, they are polarized. Applying a reverse voltage to electrolytic capacitors that are not designed specifically for that purpose (with accompanying compromises to other specs) will damage the capacitor and lead to device failure. At higher temperatures, their lifetime is limited because the seal is not perfect, and the electrolyte slowly diffuses out; frequently in older equipment that has failed, investigation will discover that the failed component(s) are electrolytic capacitors in the power supply. That diffusion happens faster at higher temperatures. The aging manifests as increased ESR and decreased capactiance. Compared to other capacitor types, both ESR and ESL is much higher; the latter makes them less effective as decoupling (hence why they are generally paralleled with other types of capacitor), and the former is high enough that the "ripple current" - the average current charging or discharging the capacitor - becomes a limiting factor. Current through a resistance generates heat, which accelerates aging, in addition to wasting power.

When requirements of size, capacitance, and/or ESR preclude other options, you may be forced to resort to tantalum capacitors. These use a solid electrolyte, free from the aging issues that plague aluminum electrolytics. They can be made with high capacitance in a small package, without dependence of capacitance on DC bias. Like aluminum electrolytics, they are polarized.  Unlike aluminum electrolytics, when reversed (or excessive) voltages damage tants, the failures are usually far more dramatic. This is the origin of the oft-repeated claim that tants can "explode". That was more of a concern with earlier devices, and "smoulder" or "catch fire" is more accurate than "explode". While tantalum capacitors need to be used more carefully than other types, every cellphone and laptop computer today contains dozens of tanatlum capacitors and in the rare event that one bursts into flame, the problem is almost invariably a lithium battery, not a tantalum capacitor. The real problem with tantalum capacitors is economic, not electronic: they are very expensive. While tantalum itself is scarce and expensive, simple math (price of tantalum per kg divided by the weight of a tantalum capactor) will tell you that the cost of the tantalum is a small part of the price. The production process for the capacitors is more involved than either ceramic or aluminum capacitors. In addition to their (overblown) reputation for fiery failure modes, in recent decades, they have acquired an unsavory reputation.

Tantalum production - used almost entirely for tantalum capacitors - has shifted away from peaceful first and second world countries like Australia, Canada, and Brazil and towards war-torn African nations. There, it has become a conflict mineral. Now, almost half of world production occurs in Rwanda, the Congo, and neighboring countries; safety regulations, if they exist at all, are rarely enforced throughout the vast tracts of nearly ungoverned land rich in mineral wealth and human suffering. The ore, "coltan", can be mined quite easily many places.  While some of the production is undoubtedly "clean" - a substantial fraction of African coltan comes from crude and danerous mines where underpaid workers toil under under deplorable conditions. Claims of forced and child labor are widespread, as is theft, fraud, and other forms of exploitation. Of course while the workers remain impoverished, it has also provided another revenue stream for the rebel armies, petty warlords, and gangs that have helped to keep the region one of perpetual strife for most of the last half century.

### Check the thickness of the wire you're using
I don't mean reading the number on the insulation. Anyone can print "22 AWG" on wire, but that doesn't make it 22 AWG. Strip it, measure the bundle of wire,  separate it to strands, count them, and measure one strand as accurately as you can (need to measure to at least 0.01 mm) and calculate what gauge it actually is. Some Chinese manufacturers sell wire with conductors significantly undersized (probably some in other countries, too, but China is by far the most prolific producer of everything, and has a culture of "success through cost-cutting", which leads the sleazier manufacturers to cheat like this. I think the problem is compounded by confusion about the conversion between AWG and square mm (I have seen wire with the correct size listed in mm<sup>2</sup> but an AWG 4 sizes larger). Whatever the mixture of incompetence and sleaze is, it's common to find wire 2-6 AWG smaller than the number they printed on the insulation. The problem is ubiquitous in cheap hookup wire, and I'm not sure I know how to get hookup wire that I would expect to be the claimed thickness. But it gets worse - In order to keep people from immediately noticing (because it's too thin) they make up the difference with extra thick insulation. Cheap hookup wire (UL1007) on AliExpress, for example, is usually 3-4 AWG too thin in the conductor, but the right thickness in insulation. So when you try to use a crimp connector with it, either you overcrimp the insulation, or undercrimp the wire. Some pre-wired JST-SM connectors I've gotten had what appears to be 32-gauge wire marked 24. I was in a hurry while assembling something with this, and didn't realize just how undersized it was. It went unnoticed until the heat from the load through the too-small wires had resulted in it heating up and turning the red insulation black; when investigating the subsequent failure (caused by the wire snapping inside the brittle carbonized insulation), I was mystefied as to why there were two black wires instead of a black and a red...

Apparently it's not just wire being exported that's like this - I hear stories of assembled equipment also made with the undersized wire, and failing as a result. The impression I get is that the manufacturers of said equipment are themselves victims (likely they are aware that undersized wire exists, were assered that the stuff they were getting was not, and maybe even measured it before choosing that supplier - who then switched to cheaper undersized wire)

### Do not use dupont line in production devices
At least not the cheap crap normally sold as that. The cheap dupont line is for prototyping only, and barely suitable for that. Real DuPont connectors, of the real DuPont design (that division was sold to Berg which was bought by Amphenol; the product line is called MiniPV) **Unfinished thought**. As long as you make sure you get ones made by Amphenol obtained through a reputable western supply house, it's a great connector. They cost around 10 cents each in quantiy for no-frills terminals, and typically more like 20-30 for decent gold plated ones, with some exceeding a buck a pop. Use the highest spring tension ones unless you have more than 20 pins ins a connector, and make sure that you or your manufacturing partner is doing a good job crimping them on (go try the pull test on some cheap dupont line - most of it doesn't even pass the pull test) If you look at the terminal of real dupont connectors, they are obviously not the same design as the cheap ones (the cheap one are a knockoff of Harwin's knockoff of MiniPV.

### If any wires are soldered to a PCB
You must provide some sort of strain relief. If the wires are held immobile (for example, the PCB might be encased in glue-lined shrink tube. that is sufficient for non-critical applications. If the wire is protected from someone yanking on it (typically by it going to another board, or to a panel mount connector in the side of the box), you should still hotglue the wire to the PCB. That is almost ubiquitous in low cost consumer devices, and this is why. When wires are soldered, some solder wicks up between the strand, and where that ridgid soldered to itself wire meets the unsoldered flexible strands, all the stress is concentrated and it becomes very susceptible to breakage, even with careful handling. If you go taking apart some consumer electronics, and try to unplug all the cables, particularly in DVD players, VCRs, and stereos, you'll often find that many of the cables only unplug on one end - the other end has something that looks like a connector, complete with terminals crimped onto the end of the wire - but these terminals are designed to solder onto the PCB rather than plug into a mating connector.

### Murphy's Law applied to Connectors
Any connector that can be plugged in backwards will be. Try to design the pinout of any non-polarized connectors so that it's safe for the device. Consider the 6-pin classic ISP connector. Notice how Reset and Vcc are opposite corners? If it is rotated 180 degrees, Vcc will be on reset, but that's fine, reset can take up to 12v because it's used for HV programming. And reset is the only pin driven high when idle, but it will be on Vcc, which will be unharmed (if not functional) like that.
Or my 3-pin UPDI header. Ground in the middle, Vcc and UPDI on the sides. Plugging it in backwards connects power to UPDI and UPDI to power. There's almost always a current limiting resistor somewhere on the UPDI line (there should be!), and the modern devices are much more forgiving of current through the clamp diodes than classic AVRs are, often being rated for max of 15-20mA, and on the tinyAVRs, it's also the HV pin (otherwise, it has protection/clamp diodes, but that's what the resistor limits the current through).
Don't use two connectors of the same type, same gender, and same number of pins on one device if they're not interchangible. It is worth using a larger connector and leaving one slot empty. You can cut the pin off the socket and fill the empty hole in the housing with glue (the plastic polarizing pins, if you can find them, are a lot more graceful, but they seem to be scarcer than hens teeth).

If you can't keep people from reversing a connector, and you can't make it harmless if they do so through pinout choice, or don't want to because it would require too many other compromises, how about a diode in series with the problem wire (likely power)?

### The Second law of Connectors
You will have one or more connectors that carry power. Connectors get abused over time, and foreign objects can get into them. You do not want them to cause a short when they do. There are many connectors that manage to keep both inacessable (for example, USB). With other connectors, generally **The side which supplies power should always be the female** - it is almost always easier for the male terminals to be shorted by contact with the environment than female terminals. The most exposed conductor should be the ground. That is why barrrel jacks are almost always center positive.

### Mains power safety
A few quick thoughts on bringing mains voltages into your devices.
* If you can use a commercial external power supply, do that instead of bringing mains into your device.
* If you must bring in mains power, use extra care in wiring and mounting. Make sure that nothing can be poked into the enclosure to make contact with it, or at least not without directed effort.
  * Either make enclosure out of a non-conductive material, with no conductive things connected to the electronics that someone could touch from the outside, or
  * Make the enclosure conductive, use a three wire cord, and tie the case the earth.
* Why do you need mains brought into the box again?  Really?

### Use thicker traces for power
Both compared to data traces, and compared to what calculations show is required. The board house doesn't charge extra for making the traces wider, why do people design so many things as if it does?

### Don't use too-good-to-be-true batteries
Too-good-to-be-true is hard to judge sometimes. With batteries you buy online it's not particularly hard, at least for standard sizes of battery. While battery capacity (and number of charge cycles) has always been one of the most dishonest specs in electronics, with even reputable companies having made misleading specs into an art form. For example they quote the capacity at some tiny load as their headline spec, so the fact that as it discharges the internal resistance skyrockets is not as visible. If the self discharge is horrendous, they'll find whatever load will maximnize the apparent capacity. That's what the legitimate businesses do - they won't lie, but they'll pick the most favorable truth to report. That's why your laptop battery, made from cells claiming over a thousand recharge cycles barely holds a charge after a few hundred. They weren't charged from the most favorable level of discharge to the most favorable state of charge, at the ideal temperature and so on. But batteries from reputable manufacturers, under laboratory conditions, surely could achieve such numbers. To be fair, determining what a more realistic number would be or how to determine it would actually be quite challenging for the battery manufacturers, not knowing the specifics of the design. The same batteries, treated with two different protocols, would differ greatly in behavior. So that is how reputable companies reliably overstate the capacity of their batteries.

The less reputable operations, generally based overseas, take a simpler approach. These are the sellers who are in the business of shipping second-rate (at best) LiPo batteries around the world without the legally-mandaded warning stickers for lithium battteries (the false customs declaration is a given). These crooks don't bother with any measurement, nor do they generally have an idea of what the specs are on their batteries - They just make the specs up! The top of the line Japanese and Western manufacturers have as of 2021 been squeezing maybe 3500 mAh out of a 18650-size Lithium-based rechargeable. Those cheap 18650 batteries you see on ebay for under a dollar couldn't possibly be a brand new battery from a market leader, yet they are advertised with capacities of 3500mAH, 5000mAh, or even 9800 mAh! These batteries, in reality, are often used - many are taken from used laptops (you know how your old laptops have practically no battery life? These unscrupulous buisnessmen don't care). These have the original outer "wrap" removed, and are rewrapped with one showing a new capacitry and a different brand ("Ultrafire" is the usual branding, which is rather ironic considering the safety reputation of lithium batteries). No, Ultrafire isn't a company or real brand - nor are a number of other "brands" of battery that you see (search Ali Express for "18650 battery pvc heat shrink" - some sellers have dozens of designs in capacities ranging from 2000 mAh to 9800 mAh). But even used 18650's aren't free - there are only so many of them, and they have some value to recyclers for their lithium, cobalt, and other metal contents; the most dishonest of the vendors have an even cheaper method: Take a hollow metal battery housing housing stuff the smallest, cheapest LiPo battery they can find into it, seal it up normally, and put a wrap claiming a high capacity onto it: 9800 mAh on the wrapper, 90 mAh battery inside.

*If the claimed capacity is higher than what Panasonic's best in that size and chemistry is*, you know it's fake (I use Panasonic as a benchmark because I know that they happen to be at the leading edge of lithium battery technology). *If you're getting a 18650 for under a dollar*, even if the claimed capacity is plausible, it's a fake. A funny thing is that when it comes to fake batteries, the actual capacity is approximately **inversely** proprtional to the claim. The outrageous capacities may well serve a similar purpose to spam email telling ridiculous stories like the "Nigerian prince who needs someone to transfer money" - that is, they are intended be obviously fake to anyone who has any relevant background knowledge. That way, none of their customers are going to know enough to call them out on their fraud. The customers will figure out that those batteries aren't as good as they claim, but not fast enough to get a refund from the seller, who has probably taken one payout, gotten banned, and returned under a new username to continue selling crap batteries. Unlike the case of the wire, there is no doubt that the sellers of these bogus batteries are very aware that they're selling crap. It won't surprise you to hear that it's also a crap shoot whether they have a protection board (for overchard, overdischarge, short circuit) whether or not they claim to (though surprisingly, most of them do seem to have some form of protection circuit - probably because whatever they batteries came from did). With the worst of these batteries whether they have protection circuits may not matter so much - they wouldn't supply enough current to trip the short circuit protection, and they store so little energy that they'd have a hard time starting a fire.

The point is, TGTBT batteries are fake. Don't be an easy mark for halfassed overseas battery scammers (it's very hard to immunize yourself against fraud from sophisticated battery scammers short of paying a fortune for them, but most sophisticated scammers have more profitable gigs than selling $1 fake batteries). If you're selling a product of course, you should never risk sub-standard batteries going into it. If it uses standard 18650 (or any other standard cell) I would suggest a cop-out along the lines of "Due to international shipping regulations, we cannot include the batteries. 18650 batteries are widely available; we suggest buying them from a reputable domestic supplier to ensure that you get safe, high quality batteries". That won't keep people from using low quality, unsafe batteries from disreputable overseas vendors, but they can't say you didn't warn them not to do exactly that. (You should :p)

#### Speaking of batteries
If you have a stack of lithium (LiPo or other variant) batteries and you need to charge them in place:
1. you *must* use a balancing charger if they are in series. There are turnkey solutions available for affordable prices, use one . This is a hard area of design, and doing it wrong can start a fire, so it's best to leave that design work to a specialist.
2. If they are in parallel, you can charge them like without using a specialized multi-cell charger only if:
  a. The batteries are matched to begin with and
  b. The charging current and load current are both small compared to the rated maximum spec. for those respective properties.
  Otherwise, you must use a battery charging module designed for that topology
3. When charging any lithium battery, ever, you need to use a specialized battery charging IC. Do not use a resistor and a zener diode, a constant current supply not designed for the purpose, or anything else like that. These methods may charge the battery a few times, but in the best case, they'll greatly shorten the life of the battery, and they could start a fire.
4. If the device is to run while being charged, the battery charging module needs to be one that supports that by providing a separate connection point for the load. Otherwise the load will confuse the charger, because it will look like the battery is at a lower state of charge than it is (because it's drawing more current at a given voltage).

### MOSFET specs: Id at Tc
Many MOSFET manufacturers, for mosfets with a heat spreading plate (ex, TO-220), specify as their headline current spec a maximum continuous drain current "At Tc = 25C" - numbers which are invariably very impressive. *They are also utterly useless*. It takes some thought to realize what that actually means: Id at Tc is the maximum drain current **while the case is held at a constant temperature**. Put another way, if a magic heatsink that kept the FET case at 25C on the outside was being used, with any more than this much current, even that wouldn't be able to keep it from overheating internally and failing, because of the finite thermal conductivity of the package. Unless you have one of those magic heatsinks (can you tell me where to buy some if you do? I need one for my perpetual motion machine), it is not a useful value for specifting a MOSFET. The maximum drain current at Ta, on the other hand is much closer to reality (in the event that it's specified - it usually is for small fets without thermal pads, while for large ones, you need to calculate the power dissipation, and use the specified thermal resistance of the package and your precision measurements of heat dissipation from your PCB or heatsink. You do have equipment to take those measurements don't you? (your more helpful manufacturers will give either a thermal resistance for "junction to ambient" under some set of conditions). Be sure to read the footnotes for the conditions they used. They specify the details of the mounting, because it relies on the PCB acting as a heatsink. Especially if that's how they're getting the headline spec, depending on how shady they are, they might use boards with extra thick 2oz copper (realistic for large power MOSFETs, not realistic for small ones), and/or  dedicate a huge area of board to dissipating heat from one tiny little FET.

I wrote a [document going into great depth about MOSFETs](https://github.com/SpenceKonde/ProductInfo/blob/master/MOSFETs/Guide.md) (since I sell them mounted on breakout boards in my [Tindie store](https://tindie.com/stores/drazzy)) - it had become clear from the questions I was getting that many people were unclear on key limiting factors. That document covers them in great detail.

### Automotive 12v power is notoriously noisy
You need far more filtering than usual to get a safe 5v from automotive 12V.

## Testing
Does anyone test their designs credibly these days? A lot of the embedded devices I've been around are like "developer tested" software. That is, the testing, if it happened at all, didn't go beyond verifying that the final bug they fixed didn't occur (under the same conditions at least) and a sanity check before it was declared working. It generally begins in ernest only when several users have made the same complaint and the designer realizes there is a problem and has not the faintest clue what it is or how to fix it - at least within startup-scale companies. One of the advantages of a larger slower moving company is that they have the resources to employ people whose job it is to test stuff, and they won't release stuff that hasn't been given basic testing; Microchip would never ship a processor that they hadn't tested that interrupts worked on, right? Er... Okay, well, they're less likely to ship products that hadn't had basic functions tested in some way.

### Cover the corner cases
Okay, so it works under ideal conditions. Test at the ends of the range you expect it to encounter. For example, if it's powered by batteries, test it with dying battery. Test it with a fully chanrged one. If it is supposed to charge the battery too, make sure it can drain the battery such that it stops functioning due to low voltage, then connect it to the charger, and make sure it comes back up cleanly. A particular concern is when the battery is "dead" but power is still reaching components (did you forget to include an undervoltage lockout or overdischarge protection? Most battery chemistrys need something like that to avoid damaging the batteries and shortening their life). Will it come back up cleanly when power is connected to charge the battery? Or will one of the parts have not fired it's reset reset because the voltage didn't fall below some threshold that would reset it cleanly, but did fall below the voltage that it needs to save state in volatile memory (on an AVR, this would be having BrownOut Detection turned off while the voltage falls below the memory retention voltage, but not below the POR rearm voltage).

### Test the extremes of the temperature range
Put it in the freezer if it's going to be used outside in the winter - some crystals stop working if they get too cold. Run at a higher temoperature than you imagine likely.

### If any part emits heat, test on a hot day
If it doesn't work, you need to either solve the technical problem, or clearly document the limitations.
In warm conditions, are any heatsinks you're using sufficient? How close does the temperature get to the ratings?

### Shake, poke, drop
Everything gets abused. Make sure your physical assembly is sufficiently robust. Shake it while it's running and make sure it doesn't reset (unless that's what it's designed to do, or is too heavy to shake). Poke and prod it while it's running (assuming it doesn't have dangerous voltages exposed. Actually, if you're considering selling something with dangerous voltages exposed, and it's not something expressly designed and marketed for such a purpose, and festooned with appropriate warnings, go ahead and electrocute yourself; it might strong for a second but it will remove your desire to ship such a hazardous product). Dangle it from it's wires. Yank out it's cable (Micro USB connectors should be the kind with the through holes, which prevent a yank from pulling the connector off the PCB, unless you have a case around it to keep the force from being handled mainly by the connector. The crap connectors that many developemnt boards have used are so bad they've given MicroUSB a bad rep in some circles - including for a time Arduino circles due to the connector on early Arduino Micros. Pick them up and drop them from as high a height as is plausible. Your customers may use the products while frazzled and hurried, at awkward physical angles, and while intoxicated - someimes all of the above. If your product is unavoidably fragile, warn people (but don't cry wolf if it's not).
